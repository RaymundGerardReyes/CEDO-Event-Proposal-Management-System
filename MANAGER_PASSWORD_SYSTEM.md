# Manager Password Generation & Storage System

## üîê Overview

This system provides secure password generation and management specifically for users with the "manager" role. When a head admin creates a manager account, a secure temporary password is automatically generated, securely stored in the database, and the manager is required to change it upon first login.

## üéØ Features

### Frontend (Settings Page)
- **Automatic Password Generation**: When "manager" role is selected, a 16-character secure password is auto-generated
- **Manual Regeneration**: Click "Regenerate" to create a new password
- **Password Visibility Toggle**: Show/hide password for easy reading
- **Copy to Clipboard**: One-click copying with visual feedback
- **Secure Transmission**: Password is sent to backend via encrypted HTTPS

### Backend (API)
- **Secure Hashing**: Uses bcryptjs with 12 salt rounds for maximum security
- **Database Storage**: Encrypted passwords stored in `users.password` field
- **Password Reset Flag**: `password_reset_required` field tracks if password change is needed
- **Login Verification**: Dedicated manager login endpoint with password validation
- **Password Change**: Secure password update functionality

## üõ† Technical Implementation

### Database Schema Updates

New columns added to `users` table:
```sql
- password VARCHAR(255) -- Stores bcrypt hashed passwords
- password_reset_required BOOLEAN DEFAULT FALSE -- Forces password change on first login
- last_login TIMESTAMP NULL -- Tracks login activity
```

### API Endpoints

#### 1. Create Manager User
```http
POST /api/users
Content-Type: application/json
Authorization: Bearer <head_admin_token>

{
  "name": "John Manager",
  "email": "manager@example.com",
  "role": "manager",
  "organization": "CEDO",
  "temporary_password": "AutoGenerated16CharPass!"
}
```

**Response:**
```json
{
  "message": "Manager user created successfully with temporary password",
  "user": {
    "id": 123,
    "name": "John Manager",
    "email": "manager@example.com",
    "role": "manager",
    "is_approved": true,
    "password_reset_required": true
  },
  "passwordInfo": {
    "hasTemporaryPassword": true,
    "mustChangeOnFirstLogin": true,
    "note": "Password has been securely hashed and stored"
  }
}
```

#### 2. Manager Login
```http
POST /api/users/login-manager
Content-Type: application/json

{
  "email": "manager@example.com",
  "password": "AutoGenerated16CharPass!"
}
```

**Response:**
```json
{
  "message": "Login successful",
  "token": "jwt_token_here",
  "user": {
    "id": 123,
    "name": "John Manager",
    "email": "manager@example.com",
    "role": "manager",
    "password_reset_required": true
  },
  "passwordInfo": {
    "mustChangePassword": true,
    "message": "You must change your password before continuing"
  }
}
```

#### 3. Change Password
```http
POST /api/users/change-password
Content-Type: application/json
Authorization: Bearer <manager_token>

{
  "currentPassword": "AutoGenerated16CharPass!",
  "newPassword": "MyNewSecurePassword123!"
}
```

**Response:**
```json
{
  "message": "Password changed successfully",
  "passwordInfo": {
    "passwordChanged": true,
    "passwordResetRequired": false
  }
}
```

## üîí Security Features

### Password Generation
- **16 characters minimum length**
- **Character diversity**: Uppercase, lowercase, numbers, symbols
- **Randomized shuffling** for maximum entropy
- **Cryptographically secure** random generation

### Password Storage
- **bcrypt hashing** with 12 salt rounds
- **No plaintext storage** - original passwords are never stored
- **Salt uniqueness** - each password gets a unique salt
- **Future-proof** - bcrypt automatically handles timing attacks

### Authentication
- **Role-based access** - only managers can use manager login
- **Account approval** - users must be approved before login
- **Token-based auth** - JWT tokens for session management
- **Password verification** - secure comparison using bcrypt

## üìù Usage Workflow

### For Head Admins (Creating Managers):
1. Navigate to Settings ‚Üí Add New User
2. Select "Manager" role
3. Password is automatically generated and displayed
4. Copy the password before submitting
5. Share password with manager securely (via secure channel)
6. Submit form - password is hashed and stored in database

### For Managers (First Login):
1. Use manager login endpoint with temporary password
2. System responds with `password_reset_required: true`
3. Must change password before accessing other features
4. Use change-password endpoint with current and new password
5. `password_reset_required` flag is cleared
6. Can now use system normally

## üß™ Testing

Run the password hashing test:
```bash
cd backend
node test-password.js
```

Expected output:
```
Testing password hashing functionality...

Original password: TempPass123!@#$%
Hashed password: $2a$12$[hash_string_here]
Hash length: 60
Password verification result: true
Wrong password verification result: false

‚úÖ Password hashing test completed successfully!
```

## üîß Configuration

### Environment Variables
- `JWT_SECRET`: Secret key for JWT token signing
- `MYSQL_*`: Database connection settings

### Frontend Configuration
- Password generation happens client-side
- Passwords transmitted via HTTPS only
- Toast notifications for user feedback

### Backend Configuration
- bcryptjs salt rounds: 12 (configurable)
- JWT token expiry: 24 hours
- Password minimum length: 8 characters

## üõ° Security Considerations

1. **Never log passwords** in production (remove console.log statements)
2. **Use HTTPS** for all API communications
3. **Secure password sharing** - use encrypted channels to share temporary passwords
4. **Regular password updates** - encourage managers to change passwords periodically
5. **Monitor login attempts** - track failed login attempts
6. **Secure token storage** - store JWT tokens securely on client side

## üìã Database Migration

The `init-db.js` script automatically adds required columns:
```bash
npm run init-db
```

This will add:
- `password` column if not exists
- `password_reset_required` column if not exists  
- `last_login` column if not exists

## üéâ Success!

The system now provides:
‚úÖ Secure password generation for managers
‚úÖ Encrypted password storage in database  
‚úÖ Forced password change on first login
‚úÖ Dedicated manager authentication
‚úÖ Password change functionality
‚úÖ Complete audit trail with login tracking 