<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AttendanceForm Database Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .info {
            background: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }

        .warning {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }

        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #0056b3;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success {
            background: #28a745;
        }

        .status-error {
            background: #dc3545;
        }

        .status-loading {
            background: #ffc107;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üß™ AttendanceForm Database Integration Test</h1>
        <p>This test verifies that the AttendanceForm component can successfully load data from your MySQL database.</p>

        <!-- Test Configuration -->
        <div class="test-section info">
            <h3>üîß Test Configuration</h3>
            <p><strong>Proposal ID:</strong> <span id="proposal-id">174</span></p>
            <p><strong>Backend URL:</strong> <span id="backend-url">http://localhost:5000</span></p>
            <p><strong>Frontend URL:</strong> <span id="frontend-url">http://localhost:3002</span></p>
            <button onclick="updateConfig()">Update Configuration</button>
        </div>

        <!-- Backend Connectivity Test -->
        <div class="test-section" id="backend-test">
            <h3><span class="status-indicator status-loading"></span>1. Backend Connectivity Test</h3>
            <p>Testing if backend server is reachable...</p>
            <div id="backend-results"></div>
        </div>

        <!-- Database Query Test -->
        <div class="test-section" id="database-test">
            <h3><span class="status-indicator status-loading"></span>2. Database Query Test</h3>
            <p>Testing if proposal data can be retrieved from MySQL...</p>
            <div id="database-results"></div>
        </div>

        <!-- AttendanceForm API Simulation -->
        <div class="test-section" id="attendance-test">
            <h3><span class="status-indicator status-loading"></span>3. AttendanceForm API Simulation</h3>
            <p>Simulating the exact API call that AttendanceForm makes...</p>
            <div id="attendance-results"></div>
        </div>

        <!-- File Status Check -->
        <div class="test-section" id="files-test">
            <h3><span class="status-indicator status-loading"></span>4. File Status Check</h3>
            <p>Checking which files are available in the database...</p>
            <div id="files-results"></div>
        </div>

        <!-- Frontend Integration Test -->
        <div class="test-section" id="frontend-test">
            <h3><span class="status-indicator status-loading"></span>5. Frontend Integration Test</h3>
            <p>Testing CORS and frontend-to-backend communication...</p>
            <div id="frontend-results"></div>
        </div>

        <!-- Debug Information -->
        <div class="test-section info">
            <h3>üêõ Debug Information</h3>
            <button onclick="runAllTests()">üîÑ Run All Tests</button>
            <button onclick="showDebugInfo()">üìä Show Debug Info</button>
            <button onclick="testSpecificProposal()">üéØ Test Different Proposal ID</button>
            <div id="debug-info"></div>
        </div>

        <!-- Console Logs -->
        <div class="test-section">
            <h3>üìù Console Logs</h3>
            <pre id="console-logs"></pre>
        </div>
    </div>

    <script>
        let proposalId = 174;
        let backendUrl = 'http://localhost:5000';
        let frontendUrl = 'http://localhost:3002';
        let logs = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            logs.push(logEntry);
            console.log(logEntry);
            updateConsoleLogs();
        }

        function updateConsoleLogs() {
            document.getElementById('console-logs').textContent = logs.slice(-20).join('\n');
        }

        function updateTestStatus(testId, status, message) {
            const testSection = document.getElementById(testId);
            const indicator = testSection.querySelector('.status-indicator');
            const resultsDiv = testSection.querySelector('div[id$="-results"]');

            indicator.className = `status-indicator status-${status}`;

            let className = '';
            switch (status) {
                case 'success': className = 'success'; break;
                case 'error': className = 'error'; break;
                case 'loading': className = 'info'; break;
                default: className = 'warning';
            }

            resultsDiv.className = className;
            resultsDiv.innerHTML = message;
        }

        async function testBackendConnectivity() {
            log('Testing backend connectivity...');
            try {
                const response = await fetch(`${backendUrl}/health`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const data = await response.text();
                    updateTestStatus('backend-test', 'success', `‚úÖ Backend is reachable<br><strong>Response:</strong> ${data}`);
                    log('Backend connectivity: SUCCESS');
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                updateTestStatus('backend-test', 'error', `‚ùå Backend not reachable<br><strong>Error:</strong> ${error.message}<br><strong>Check:</strong> Is backend running on ${backendUrl}?`);
                log(`Backend connectivity: ERROR - ${error.message}`, 'error');
                return false;
            }
        }

        async function testDatabaseQuery() {
            log('Testing database query...');
            try {
                const response = await fetch(`${backendUrl}/api/proposals/mysql/debug/list`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const data = await response.json();
                    const proposalCount = data.proposals?.length || 0;
                    const proposalIds = data.proposals?.slice(0, 5).map(p => p.id).join(', ') || 'None';

                    updateTestStatus('database-test', 'success',
                        `‚úÖ Database query successful<br>` +
                        `<strong>Total Proposals:</strong> ${proposalCount}<br>` +
                        `<strong>Recent IDs:</strong> ${proposalIds}<br>` +
                        `<strong>Target ID ${proposalId}:</strong> ${data.proposals?.find(p => p.id == proposalId) ? 'Found ‚úÖ' : 'Not Found ‚ùå'}`
                    );
                    log(`Database query: SUCCESS - Found ${proposalCount} proposals`);
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                updateTestStatus('database-test', 'error', `‚ùå Database query failed<br><strong>Error:</strong> ${error.message}`);
                log(`Database query: ERROR - ${error.message}`, 'error');
                return false;
            }
        }

        async function testAttendanceFormAPI() {
            log('Testing AttendanceForm API simulation...');
            try {
                const apiUrl = `${backendUrl}/api/proposals/mysql/${proposalId}`;
                log(`Making request to: ${apiUrl}`);

                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                });

                log(`Response status: ${response.status} ${response.statusText}`);

                if (response.ok) {
                    const data = await response.json();

                    updateTestStatus('attendance-test', 'success',
                        `‚úÖ AttendanceForm API simulation successful<br>` +
                        `<strong>Proposal ID:</strong> ${data.proposal.id}<br>` +
                        `<strong>Organization:</strong> ${data.proposal.organizationName}<br>` +
                        `<strong>Status:</strong> ${data.proposal.proposalStatus}<br>` +
                        `<strong>Event:</strong> ${data.proposal.eventName || 'N/A'}`
                    );
                    log(`AttendanceForm API: SUCCESS - Loaded proposal ${data.proposal.id}`);
                    return data.proposal;
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                updateTestStatus('attendance-test', 'error', `‚ùå AttendanceForm API failed<br><strong>Error:</strong> ${error.message}`);
                log(`AttendanceForm API: ERROR - ${error.message}`, 'error');
                return null;
            }
        }

        async function testFileStatus(proposalData) {
            log('Testing file status...');
            if (!proposalData) {
                updateTestStatus('files-test', 'error', '‚ùå Cannot check files - no proposal data');
                return;
            }

            try {
                const files = {
                    'Accomplishment Report': proposalData.accomplishmentReportFileName,
                    'Pre-Registration List': proposalData.preRegistrationFileName,
                    'Final Attendance List': proposalData.finalAttendanceFileName
                };

                let fileStatus = '';
                let hasFiles = false;

                for (const [type, filename] of Object.entries(files)) {
                    const status = filename ? '‚úÖ' : '‚ùå';
                    const displayName = filename || 'Not uploaded';
                    fileStatus += `<strong>${type}:</strong> ${status} ${displayName}<br>`;
                    if (filename) hasFiles = true;
                }

                updateTestStatus('files-test', hasFiles ? 'success' : 'warning',
                    `${hasFiles ? '‚úÖ' : '‚ö†Ô∏è'} File status check complete<br>${fileStatus}`
                );
                log(`File status: ${hasFiles ? 'Files found' : 'No files found'}`);
            } catch (error) {
                updateTestStatus('files-test', 'error', `‚ùå File status check failed<br><strong>Error:</strong> ${error.message}`);
                log(`File status: ERROR - ${error.message}`, 'error');
            }
        }

        async function testFrontendIntegration() {
            log('Testing frontend integration...');
            try {
                // Test CORS and frontend communication
                const testUrl = `${backendUrl}/api/proposals/mysql/${proposalId}`;

                const response = await fetch(testUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': frontendUrl
                    },
                    credentials: 'include'
                });

                if (response.ok) {
                    updateTestStatus('frontend-test', 'success',
                        `‚úÖ Frontend integration working<br>` +
                        `<strong>CORS:</strong> Enabled<br>` +
                        `<strong>Credentials:</strong> Included<br>` +
                        `<strong>Origin:</strong> ${frontendUrl}`
                    );
                    log('Frontend integration: SUCCESS');
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                updateTestStatus('frontend-test', 'error',
                    `‚ùå Frontend integration failed<br>` +
                    `<strong>Error:</strong> ${error.message}<br>` +
                    `<strong>Check:</strong> CORS settings, credentials, frontend URL`
                );
                log(`Frontend integration: ERROR - ${error.message}`, 'error');
            }
        }

        async function runAllTests() {
            log('=== STARTING COMPREHENSIVE TEST SUITE ===');

            // Reset all test statuses
            ['backend-test', 'database-test', 'attendance-test', 'files-test', 'frontend-test'].forEach(testId => {
                updateTestStatus(testId, 'loading', 'Running test...');
            });

            // Run tests in sequence
            const backendOk = await testBackendConnectivity();
            if (!backendOk) return;

            const databaseOk = await testDatabaseQuery();
            if (!databaseOk) return;

            const proposalData = await testAttendanceFormAPI();
            await testFileStatus(proposalData);
            await testFrontendIntegration();

            log('=== TEST SUITE COMPLETED ===');
        }

        function updateConfig() {
            const newProposalId = prompt('Enter Proposal ID:', proposalId);
            const newBackendUrl = prompt('Enter Backend URL:', backendUrl);
            const newFrontendUrl = prompt('Enter Frontend URL:', frontendUrl);

            if (newProposalId) proposalId = parseInt(newProposalId);
            if (newBackendUrl) backendUrl = newBackendUrl;
            if (newFrontendUrl) frontendUrl = newFrontendUrl;

            document.getElementById('proposal-id').textContent = proposalId;
            document.getElementById('backend-url').textContent = backendUrl;
            document.getElementById('frontend-url').textContent = frontendUrl;

            log(`Configuration updated: Proposal ID=${proposalId}, Backend=${backendUrl}, Frontend=${frontendUrl}`);
        }

        function showDebugInfo() {
            const debugInfo = `
                <h4>üîç Environment Information</h4>
                <p><strong>User Agent:</strong> ${navigator.userAgent}</p>
                <p><strong>Current URL:</strong> ${window.location.href}</p>
                <p><strong>Protocol:</strong> ${window.location.protocol}</p>
                <p><strong>Timestamp:</strong> ${new Date().toISOString()}</p>
                
                <h4>üîß Configuration</h4>
                <p><strong>Proposal ID:</strong> ${proposalId}</p>
                <p><strong>Backend URL:</strong> ${backendUrl}</p>
                <p><strong>Frontend URL:</strong> ${frontendUrl}</p>
                
                <h4>üåê Network Information</h4>
                <p><strong>Online:</strong> ${navigator.onLine ? 'Yes' : 'No'}</p>
                <p><strong>Connection:</strong> ${navigator.connection?.effectiveType || 'Unknown'}</p>
            `;
            document.getElementById('debug-info').innerHTML = debugInfo;
        }

        function testSpecificProposal() {
            const newId = prompt('Enter Proposal ID to test:', proposalId);
            if (newId && !isNaN(newId)) {
                proposalId = parseInt(newId);
                document.getElementById('proposal-id').textContent = proposalId;
                log(`Testing with new Proposal ID: ${proposalId}`);
                runAllTests();
            }
        }

        // Initialize page
        window.onload = function () {
            log('AttendanceForm Database Integration Test initialized');
            showDebugInfo();
            setTimeout(runAllTests, 1000); // Auto-run tests after 1 second
        };

        // Handle errors
        window.onerror = function (message, source, lineno, colno, error) {
            log(`JavaScript Error: ${message} at ${source}:${lineno}`, 'error');
        };
    </script>
</body>

</html>